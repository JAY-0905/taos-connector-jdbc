


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > RestfulDriver</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.taosdata.jdbc.rs</a>
</div>

<h1>Coverage Summary for Class: RestfulDriver (com.taosdata.jdbc.rs)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RestfulDriver</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (12/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    91.3%
  </span>
  <span class="absValue">
    (63/69)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.taosdata.jdbc.rs;
&nbsp;
&nbsp;import com.alibaba.fastjson.JSON;
&nbsp;import com.alibaba.fastjson.JSONObject;
&nbsp;import com.taosdata.jdbc.*;
&nbsp;import com.taosdata.jdbc.enums.WSFunction;
&nbsp;import com.taosdata.jdbc.utils.HttpClientPoolUtil;
&nbsp;import com.taosdata.jdbc.ws.FutureResponse;
&nbsp;import com.taosdata.jdbc.ws.InFlightRequest;
&nbsp;import com.taosdata.jdbc.ws.Transport;
&nbsp;import com.taosdata.jdbc.ws.WSConnection;
&nbsp;import com.taosdata.jdbc.ws.entity.*;
&nbsp;
&nbsp;import java.nio.ByteOrder;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.sql.*;
&nbsp;import java.util.Base64;
&nbsp;import java.util.Properties;
&nbsp;import java.util.logging.Logger;
&nbsp;
<b class="fc">&nbsp;public class RestfulDriver extends AbstractDriver {</b>
&nbsp;
&nbsp;    public static final String URL_PREFIX = &quot;jdbc:TAOS-RS://&quot;;
&nbsp;
&nbsp;    static {
&nbsp;        try {
<b class="fc">&nbsp;            DriverManager.registerDriver(new RestfulDriver());</b>
<b class="nc">&nbsp;        } catch (SQLException e) {</b>
<b class="nc">&nbsp;            throw TSDBError.createRuntimeException(TSDBErrorNumbers.ERROR_URL_NOT_SET, e);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Connection connect(String url, Properties info) throws SQLException {
&nbsp;        // throw SQLException if url is null
<b class="fc">&nbsp;        if (url == null || url.trim().isEmpty() || url.trim().replaceAll(&quot;\\s&quot;, &quot;&quot;).isEmpty())</b>
<b class="nc">&nbsp;            throw TSDBError.createSQLException(TSDBErrorNumbers.ERROR_URL_NOT_SET);</b>
&nbsp;
&nbsp;        // return null if url is not be accepted
<b class="fc">&nbsp;        if (!acceptsURL(url))</b>
<b class="fc">&nbsp;            return null;</b>
&nbsp;
<b class="fc">&nbsp;        Properties props = parseURL(url, info);</b>
<b class="fc">&nbsp;        ConnectionParam param = ConnectionParam.getParam(props);</b>
<b class="fc">&nbsp;        String batchLoad = info.getProperty(TSDBDriver.PROPERTY_KEY_BATCH_LOAD);</b>
<b class="fc">&nbsp;        if (Boolean.parseBoolean(batchLoad)) {</b>
<b class="fc">&nbsp;            return getWSConnection(url, param, props);</b>
&nbsp;        }
<b class="fc">&nbsp;        HttpClientPoolUtil.init(props);</b>
&nbsp;
<b class="fc">&nbsp;        String auth = null;</b>
&nbsp;
<b class="fc">&nbsp;        if (param.getUser() != null &amp;&amp; param.getPassword() != null) {</b>
<b class="fc">&nbsp;            auth = Base64.getEncoder().encodeToString(</b>
<b class="fc">&nbsp;                    (param.getUser() + &quot;:&quot; + param.getPassword()).getBytes(StandardCharsets.UTF_8));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        RestfulConnection conn = new RestfulConnection(param.getHost(), param.getPort(), props, param.getDatabase(),</b>
<b class="fc">&nbsp;                url, auth, param.isUseSsl(), param.getCloudToken(), param.getTz());</b>
<b class="fc">&nbsp;        if (param.getDatabase() != null &amp;&amp; !param.getDatabase().trim().replaceAll(&quot;\\s&quot;, &quot;&quot;).isEmpty()) {</b>
<b class="fc">&nbsp;            try (Statement stmt = conn.createStatement()) {</b>
<b class="fc">&nbsp;                stmt.execute(&quot;use &quot; + param.getDatabase());</b>
<b class="fc">&nbsp;            }</b>
&nbsp;        }
<b class="fc">&nbsp;        return conn;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean acceptsURL(String url) throws SQLException {
<b class="fc">&nbsp;        if (url == null)</b>
<b class="nc">&nbsp;            throw TSDBError.createSQLException(TSDBErrorNumbers.ERROR_URL_NOT_SET);</b>
<b class="fc">&nbsp;        return url.trim().length() &gt; 0 &amp;&amp; url.startsWith(URL_PREFIX);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public DriverPropertyInfo[] getPropertyInfo(String url, Properties info) throws SQLException {
<b class="fc">&nbsp;        if (info == null) {</b>
<b class="fc">&nbsp;            info = new Properties();</b>
&nbsp;        }
<b class="fc">&nbsp;        if (acceptsURL(url)) {</b>
<b class="nc">&nbsp;            info = parseURL(url, info);</b>
&nbsp;        }
<b class="fc">&nbsp;        return getPropertyInfo(info);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int getMajorVersion() {
<b class="fc">&nbsp;        return 3;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int getMinorVersion() {
<b class="fc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean jdbcCompliant() {
<b class="fc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Logger getParentLogger() throws SQLFeatureNotSupportedException {
<b class="fc">&nbsp;        throw new SQLFeatureNotSupportedException();</b>
&nbsp;    }
&nbsp;
&nbsp;    private Connection getWSConnection(String url, ConnectionParam param, Properties props) throws SQLException {
<b class="fc">&nbsp;        InFlightRequest inFlightRequest = new InFlightRequest(param.getRequestTimeout(), param.getMaxRequest());</b>
<b class="fc">&nbsp;        Transport transport = new Transport(WSFunction.WS, param, inFlightRequest);</b>
&nbsp;
<b class="fc">&nbsp;        transport.setTextMessageHandler(message -&gt; {</b>
<b class="fc">&nbsp;            JSONObject jsonObject = JSON.parseObject(message);</b>
<b class="fc">&nbsp;            Action action = Action.of(jsonObject.getString(&quot;action&quot;));</b>
<b class="fc">&nbsp;            Response response = jsonObject.toJavaObject(action.getResponseClazz());</b>
<b class="fc">&nbsp;            FutureResponse remove = inFlightRequest.remove(response.getAction(), response.getReqId());</b>
<b class="fc">&nbsp;            if (null != remove) {</b>
<b class="fc">&nbsp;                remove.getFuture().complete(response);</b>
&nbsp;            }
&nbsp;        });
<b class="fc">&nbsp;        transport.setBinaryMessageHandler(byteBuffer -&gt; {</b>
<b class="fc">&nbsp;            byteBuffer.order(ByteOrder.LITTLE_ENDIAN);</b>
<b class="fc">&nbsp;            byteBuffer.position(8);</b>
<b class="fc">&nbsp;            long id = byteBuffer.getLong();</b>
<b class="fc">&nbsp;            FutureResponse remove = inFlightRequest.remove(Action.FETCH_BLOCK.getAction(), id);</b>
<b class="fc">&nbsp;            if (null != remove) {</b>
<b class="fc">&nbsp;                FetchBlockResp fetchBlockResp = new FetchBlockResp(id, byteBuffer);</b>
<b class="fc">&nbsp;                remove.getFuture().complete(fetchBlockResp);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="fc">&nbsp;        Transport.checkConnection(transport, param.getConnectTimeout());</b>
&nbsp;
<b class="fc">&nbsp;        ConnectReq connectReq = new ConnectReq();</b>
<b class="fc">&nbsp;        connectReq.setReqId(1);</b>
<b class="fc">&nbsp;        connectReq.setUser(param.getUser());</b>
<b class="fc">&nbsp;        connectReq.setPassword(param.getPassword());</b>
<b class="fc">&nbsp;        connectReq.setDb(param.getDatabase());</b>
&nbsp;        // 目前仅支持bi模式，下游接口值为0，此处做转换
<b class="fc">&nbsp;        if(param.getConnectMode() == 1){</b>
<b class="nc">&nbsp;            connectReq.setMode(0);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        ConnectResp auth = (ConnectResp) transport.send(new Request(Action.CONN.getAction(), connectReq));</b>
&nbsp;
<b class="fc">&nbsp;        if (Code.SUCCESS.getCode() != auth.getCode()) {</b>
<b class="fc">&nbsp;            transport.close();</b>
<b class="fc">&nbsp;            throw new SQLException(&quot;(0x&quot; + Integer.toHexString(auth.getCode()) + &quot;):&quot; + &quot;auth failure:&quot; + auth.getMessage());</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        TaosGlobalConfig.setCharset(props.getProperty(TSDBDriver.PROPERTY_KEY_CHARSET));</b>
<b class="fc">&nbsp;        return new WSConnection(url, props, transport, param);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-10-08 10:56</div>
</div>
</body>
</html>
