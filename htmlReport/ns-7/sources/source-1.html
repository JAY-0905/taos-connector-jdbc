


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > AbstractWSResultSet</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.taosdata.jdbc.ws</a>
</div>

<h1>Coverage Summary for Class: AbstractWSResultSet (com.taosdata.jdbc.ws)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AbstractWSResultSet</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92.2%
  </span>
  <span class="absValue">
    (47/51)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.taosdata.jdbc.ws;
&nbsp;
&nbsp;import com.taosdata.jdbc.AbstractResultSet;
&nbsp;import com.taosdata.jdbc.TSDBError;
&nbsp;import com.taosdata.jdbc.TSDBErrorNumbers;
&nbsp;import com.taosdata.jdbc.enums.DataType;
&nbsp;import com.taosdata.jdbc.rs.RestfulResultSet;
&nbsp;import com.taosdata.jdbc.rs.RestfulResultSetMetaData;
&nbsp;import com.taosdata.jdbc.ws.entity.*;
&nbsp;
&nbsp;import java.sql.ResultSetMetaData;
&nbsp;import java.sql.SQLException;
&nbsp;import java.sql.Statement;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;
&nbsp;public abstract class AbstractWSResultSet extends AbstractResultSet {
&nbsp;    protected final Statement statement;
&nbsp;    protected final Transport transport;
&nbsp;    protected final long queryId;
&nbsp;    protected final long reqId;
&nbsp;
&nbsp;    protected volatile boolean isClosed;
&nbsp;    // meta
&nbsp;    protected final ResultSetMetaData metaData;
<b class="fc">&nbsp;    protected final List&lt;RestfulResultSet.Field&gt; fields = new ArrayList&lt;&gt;();</b>
&nbsp;    protected final List&lt;String&gt; columnNames;
&nbsp;    protected List&lt;Integer&gt; fieldLength;
&nbsp;    // data
<b class="fc">&nbsp;    protected List&lt;List&lt;Object&gt;&gt; result = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;    protected int numOfRows = 0;</b>
<b class="fc">&nbsp;    protected int rowIndex = 0;</b>
&nbsp;    private boolean isCompleted;
&nbsp;
&nbsp;    protected AbstractWSResultSet(Statement statement, Transport transport,
<b class="fc">&nbsp;                               QueryResp response, String database) throws SQLException {</b>
<b class="fc">&nbsp;        this.statement = statement;</b>
<b class="fc">&nbsp;        this.transport = transport;</b>
<b class="fc">&nbsp;        this.queryId = response.getId();</b>
<b class="fc">&nbsp;        this.reqId = response.getReqId();</b>
<b class="fc">&nbsp;        columnNames = Arrays.asList(response.getFieldsNames());</b>
<b class="fc">&nbsp;        for (int i = 0; i &lt; response.getFieldsCount(); i++) {</b>
<b class="fc">&nbsp;            String colName = response.getFieldsNames()[i];</b>
<b class="fc">&nbsp;            int taosType = response.getFieldsTypes()[i];</b>
<b class="fc">&nbsp;            int jdbcType = DataType.convertTaosType2DataType(taosType).getJdbcTypeValue();</b>
<b class="fc">&nbsp;            int length = response.getFieldsLengths()[i];</b>
<b class="fc">&nbsp;            fields.add(new RestfulResultSet.Field(colName, jdbcType, length, &quot;&quot;, taosType));</b>
&nbsp;        }
<b class="fc">&nbsp;        this.metaData = new RestfulResultSetMetaData(database, fields);</b>
<b class="fc">&nbsp;        this.timestampPrecision = response.getPrecision();</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean forward() {
<b class="fc">&nbsp;        if (this.rowIndex &gt; this.numOfRows) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return ((++this.rowIndex) &lt; this.numOfRows);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void reset() {
<b class="fc">&nbsp;        this.rowIndex = 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean next() throws SQLException {
<b class="fc">&nbsp;        if (isClosed()) {</b>
<b class="nc">&nbsp;            throw TSDBError.createSQLException(TSDBErrorNumbers.ERROR_RESULTSET_CLOSED);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        if (this.forward()) {</b>
<b class="fc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Request request = RequestFactory.generateFetch(queryId, reqId);</b>
<b class="fc">&nbsp;        FetchResp fetchResp = (FetchResp)transport.send(request);</b>
<b class="fc">&nbsp;        if (Code.SUCCESS.getCode() != fetchResp.getCode()) {</b>
<b class="nc">&nbsp;            throw TSDBError.createSQLException(TSDBErrorNumbers.ERROR_UNKNOWN, fetchResp.getMessage());</b>
&nbsp;        }
<b class="fc">&nbsp;        this.reset();</b>
<b class="fc">&nbsp;        if (fetchResp.isCompleted() || fetchResp.getRows() == 0) {</b>
<b class="fc">&nbsp;            this.isCompleted = true;</b>
<b class="fc">&nbsp;            return false;</b>
&nbsp;        }
<b class="fc">&nbsp;        fieldLength = Arrays.asList(fetchResp.getLengths());</b>
<b class="fc">&nbsp;        this.numOfRows = fetchResp.getRows();</b>
<b class="fc">&nbsp;        this.result = fetchJsonData();</b>
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    public abstract List&lt;List&lt;Object&gt;&gt; fetchJsonData() throws SQLException;
&nbsp;
&nbsp;    @Override
&nbsp;    public void close() throws SQLException {
<b class="fc">&nbsp;        synchronized (this) {</b>
<b class="fc">&nbsp;            if (!this.isClosed) {</b>
<b class="fc">&nbsp;                this.isClosed = true;</b>
<b class="fc">&nbsp;                if (result != null &amp;&amp; !result.isEmpty() &amp;&amp; !isCompleted) {</b>
<b class="fc">&nbsp;                    FetchReq closeReq = new FetchReq();</b>
<b class="fc">&nbsp;                    closeReq.setReqId(queryId);</b>
<b class="fc">&nbsp;                    closeReq.setId(queryId);</b>
<b class="fc">&nbsp;                    transport.sendWithoutRep(new Request(Action.FREE_RESULT.getAction(), closeReq));</b>
&nbsp;                }
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ResultSetMetaData getMetaData() throws SQLException {
<b class="fc">&nbsp;        if (isClosed())</b>
<b class="nc">&nbsp;            throw TSDBError.createSQLException(TSDBErrorNumbers.ERROR_RESULTSET_CLOSED);</b>
<b class="fc">&nbsp;        return this.metaData;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isClosed() throws SQLException {
<b class="fc">&nbsp;        return isClosed;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-10-08 10:56</div>
</div>
</body>
</html>
