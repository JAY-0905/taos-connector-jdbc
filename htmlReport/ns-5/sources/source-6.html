


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > JNIConsumer</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.taosdata.jdbc.tmq</a>
</div>

<h1>Coverage Summary for Class: JNIConsumer (com.taosdata.jdbc.tmq)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JNIConsumer</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80%
  </span>
  <span class="absValue">
    (24/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    79.4%
  </span>
  <span class="absValue">
    (81/102)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.taosdata.jdbc.tmq;
&nbsp;
&nbsp;import com.taosdata.jdbc.TSDBConstants;
&nbsp;import com.taosdata.jdbc.common.Consumer;
&nbsp;
&nbsp;import java.sql.SQLException;
&nbsp;import java.time.Duration;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import static com.taosdata.jdbc.TSDBErrorNumbers.ERROR_TMQ_CONSUMER_NULL;
&nbsp;
&nbsp;public class JNIConsumer&lt;V&gt; implements  Consumer&lt;V&gt; {
&nbsp;
&nbsp;    private final TMQConnector connector;
&nbsp;
<b class="fc">&nbsp;    public JNIConsumer() {</b>
<b class="fc">&nbsp;        connector = new TMQConnector();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void create(Properties properties) throws SQLException {
<b class="fc">&nbsp;        long config = connector.createConfig(properties);</b>
&nbsp;        try {
<b class="fc">&nbsp;            connector.createConsumer(config);</b>
&nbsp;        } finally {
<b class="fc">&nbsp;            connector.destroyConf(config);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void subscribe(Collection&lt;String&gt; topics) throws SQLException {
<b class="fc">&nbsp;        long topicPointer = 0L;</b>
&nbsp;        try {
<b class="fc">&nbsp;            topicPointer = connector.createTopic(topics);</b>
<b class="fc">&nbsp;            connector.subscribe(topicPointer);</b>
&nbsp;        } finally {
<b class="fc">&nbsp;            if (topicPointer != TSDBConstants.JNI_NULL_POINTER) {</b>
<b class="fc">&nbsp;                connector.destroyTopic(topicPointer);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void unsubscribe() throws SQLException {
<b class="fc">&nbsp;        connector.unsubscribe();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;String&gt; subscription() throws SQLException {
<b class="fc">&nbsp;        return connector.subscription();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ConsumerRecords&lt;V&gt; poll(Duration timeout, Deserializer&lt;V&gt; deserializer) throws SQLException {
<b class="fc">&nbsp;        long resultSet = connector.poll(timeout.toMillis());</b>
&nbsp;        // when tmq pointer is null or result set is null
<b class="fc">&nbsp;        if (resultSet == 0 || resultSet == ERROR_TMQ_CONSUMER_NULL) {</b>
<b class="fc">&nbsp;            return ConsumerRecords.emptyRecord();</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        int timestampPrecision = connector.getResultTimePrecision(resultSet);</b>
&nbsp;
<b class="fc">&nbsp;        ConsumerRecords&lt;V&gt; records = new ConsumerRecords&lt;&gt;();</b>
<b class="fc">&nbsp;        String topic = connector.getTopicName(resultSet);</b>
<b class="fc">&nbsp;        String dbName = connector.getDbName(resultSet);</b>
<b class="fc">&nbsp;        int vGroupId = connector.getVgroupId(resultSet);</b>
<b class="fc">&nbsp;        long offset = connector.getOffset(resultSet);</b>
<b class="fc">&nbsp;        String tableName = connector.getTableName(resultSet);</b>
&nbsp;
<b class="fc">&nbsp;        TopicPartition tp = new TopicPartition(topic, vGroupId);</b>
&nbsp;
<b class="fc">&nbsp;        try (TMQResultSet rs = new TMQResultSet(connector, resultSet, timestampPrecision, dbName, tableName)) {</b>
<b class="fc">&nbsp;            while (rs.next()) {</b>
<b class="fc">&nbsp;                V v = deserializer.deserialize(rs, topic, dbName);</b>
<b class="fc">&nbsp;                ConsumerRecord&lt;V&gt; r = new ConsumerRecord&lt;&gt;(topic, dbName, vGroupId, offset, v);</b>
<b class="fc">&nbsp;                records.put(tp, r);</b>
<b class="fc">&nbsp;            }</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        return records;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void commitAsync(OffsetCommitCallback&lt;V&gt; callback) throws SQLException {
<b class="fc">&nbsp;        OffsetWaitCallback&lt;V&gt; call = new OffsetWaitCallback&lt;&gt;(getAllConsumed(), this, callback);</b>
&nbsp;
<b class="fc">&nbsp;        connector.asyncCommit(call);</b>
&nbsp;    }
&nbsp;
&nbsp;    private Map&lt;TopicPartition, OffsetAndMetadata&gt; getAllConsumed() throws SQLException {
<b class="fc">&nbsp;        Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        this.subscription().forEach(topic -&gt; {</b>
<b class="fc">&nbsp;            List&lt;Assignment&gt; topicAssignment = connector.getTopicAssignment(topic);</b>
<b class="fc">&nbsp;            topicAssignment.forEach(assignment -&gt; {</b>
<b class="fc">&nbsp;                TopicPartition tp = new TopicPartition(topic, assignment.getVgId());</b>
<b class="fc">&nbsp;                OffsetAndMetadata metadata = new OffsetAndMetadata(assignment.getCurrentOffset());</b>
<b class="fc">&nbsp;                offsets.put(tp, metadata);</b>
&nbsp;            });
&nbsp;        });
<b class="fc">&nbsp;        return offsets;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void commitAsync(final Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, OffsetCommitCallback&lt;V&gt; callback) {
<b class="nc">&nbsp;        for (Map.Entry&lt;TopicPartition, OffsetAndMetadata&gt; entry : offsets.entrySet()) {</b>
<b class="nc">&nbsp;            Map&lt;TopicPartition, OffsetAndMetadata&gt; offset = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            offset.put(entry.getKey(), entry.getValue());</b>
<b class="nc">&nbsp;            connector.asyncCommit(entry.getKey().getTopic(), entry.getKey().getVGroupId(), entry.getValue().offset(),</b>
&nbsp;                    new OffsetWaitCallback&lt;&gt;(offset, this, callback));
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void commitSync() throws SQLException {
<b class="fc">&nbsp;        connector.syncCommit();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void commitSync(Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets) throws SQLException {
<b class="fc">&nbsp;        for (Map.Entry&lt;TopicPartition, OffsetAndMetadata&gt; entry : offsets.entrySet()) {</b>
<b class="fc">&nbsp;            connector.commitOffsetSync(entry.getKey().getTopic(), entry.getKey().getVGroupId(), entry.getValue().offset());</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void seek(TopicPartition partition, long offset) {
<b class="fc">&nbsp;        connector.seek(partition.getTopic(), partition.getVGroupId(), offset);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long position(TopicPartition partition) throws SQLException {
<b class="fc">&nbsp;        return connector.position(partition.getTopic(), partition.getVGroupId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;TopicPartition, Long&gt; position(String topic) throws SQLException {
<b class="fc">&nbsp;        List&lt;TopicPartition&gt; collect = connector.getTopicAssignment(topic).stream()</b>
<b class="fc">&nbsp;                .map(a -&gt; new TopicPartition(topic, a.getVgId())).collect(Collectors.toList());</b>
<b class="fc">&nbsp;        Map&lt;TopicPartition, Long&gt; map = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        for (TopicPartition topicPartition : collect) {</b>
<b class="fc">&nbsp;            map.put(topicPartition, position(topicPartition));</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return map;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;TopicPartition, Long&gt; beginningOffsets(String topic) {
<b class="nc">&nbsp;        return connector.getTopicAssignment(topic).stream()</b>
<b class="nc">&nbsp;                .collect(HashMap::new</b>
<b class="nc">&nbsp;                        , (m, a) -&gt; m.put(new TopicPartition(topic, a.getVgId()), a.getBegin())</b>
&nbsp;                        , HashMap::putAll
&nbsp;                );
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;TopicPartition, Long&gt; endOffsets(String topic) {
<b class="fc">&nbsp;        return connector.getTopicAssignment(topic).stream()</b>
<b class="fc">&nbsp;                .collect(HashMap::new</b>
<b class="fc">&nbsp;                        , (m, a) -&gt; m.put(new TopicPartition(topic, a.getVgId()), a.getEnd())</b>
&nbsp;                        , HashMap::putAll
&nbsp;                );
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void seekToBeginning(Collection&lt;TopicPartition&gt; partitions) throws SQLException {
<b class="nc">&nbsp;        Map&lt;TopicPartition, Long&gt; beginningOffsets = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (TopicPartition partition : partitions) {</b>
<b class="nc">&nbsp;            if (beginningOffsets.containsKey(partition)) {</b>
<b class="nc">&nbsp;                Long aLong = beginningOffsets.get(partition);</b>
<b class="nc">&nbsp;                seek(partition, aLong);</b>
<b class="nc">&nbsp;            } else {</b>
<b class="nc">&nbsp;                beginningOffsets(partition.getTopic()).forEach((tp, offset) -&gt; {</b>
<b class="nc">&nbsp;                    if (tp.getVGroupId() == partition.getVGroupId()) {</b>
<b class="nc">&nbsp;                        seek(tp, offset);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        beginningOffsets.put(tp, offset);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void seekToEnd(Collection&lt;TopicPartition&gt; partitions) throws SQLException {
<b class="fc">&nbsp;        Map&lt;TopicPartition, Long&gt; endOffsets = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        for (TopicPartition partition : partitions) {</b>
<b class="fc">&nbsp;            if (endOffsets.containsKey(partition)) {</b>
<b class="fc">&nbsp;                Long aLong = endOffsets.get(partition);</b>
<b class="fc">&nbsp;                seek(partition, aLong);</b>
<b class="fc">&nbsp;            } else {</b>
<b class="fc">&nbsp;                endOffsets(partition.getTopic()).forEach((tp, offset) -&gt; {</b>
<b class="fc">&nbsp;                    if (tp.getVGroupId() == partition.getVGroupId()) {</b>
<b class="fc">&nbsp;                        seek(tp, offset);</b>
&nbsp;                    } else {
<b class="fc">&nbsp;                        endOffsets.put(tp, offset);</b>
&nbsp;                    }
&nbsp;                });
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;TopicPartition&gt; assignment() throws SQLException {
<b class="fc">&nbsp;        return subscription().stream().map(topic -&gt; {</b>
<b class="fc">&nbsp;            List&lt;Assignment&gt; topicAssignment = connector.getTopicAssignment(topic);</b>
<b class="fc">&nbsp;            return topicAssignment.stream().map(a -&gt; new TopicPartition(topic, a.getVgId())).collect(Collectors.toList());</b>
<b class="fc">&nbsp;        }).flatMap(Collection::stream).collect(Collectors.toSet());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public OffsetAndMetadata committed(TopicPartition partition) throws SQLException {
<b class="fc">&nbsp;        long l = connector.committed(partition.getTopic(), partition.getVGroupId());</b>
<b class="fc">&nbsp;        return new OffsetAndMetadata(l, null);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;TopicPartition, OffsetAndMetadata&gt; committed(Set&lt;TopicPartition&gt; partitions) throws SQLException {
<b class="fc">&nbsp;        Map&lt;TopicPartition, OffsetAndMetadata&gt; map = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;        for (TopicPartition partition : partitions) {</b>
<b class="fc">&nbsp;            map.put(partition, committed(partition));</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return map;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void close() throws SQLException {
<b class="fc">&nbsp;        connector.closeConsumer();</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getErrMsg(int code) {
<b class="nc">&nbsp;        return connector.getErrMsg(code);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-10-08 10:56</div>
</div>
</body>
</html>
